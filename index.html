<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Expiry Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#f7f7f7; margin:0; padding:20px; display:flex; justify-content:center; }
    .card { background:#fff; padding:24px; max-width:520px; width:100%; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,0.08); }
    h1 { margin:0 0 10px; font-size:22px; }
    label { display:block; margin-top:14px; font-weight:600; }
    input { width:100%; padding:10px; margin-top:6px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
    button { margin-top:18px; width:100%; padding:12px; background:#111; color:#fff; border:none; border-radius:6px; font-size:16px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .result { margin-top:20px; padding:12px; border-radius:6px; background:#f0f0f0; white-space:pre-wrap; font-size:14px; min-height:44px; }
    .ok { color:#0a7; font-weight:700; }
    .bad { color:#c00; font-weight:700; }
    .muted { color:#666; font-size:12px; margin-top:8px; }
  </style>
</head>

<body>
  <div class="card">
    <h1>Expiry Checker</h1>

    <label>Server URL</label>
    <input id="server" placeholder="https://example.com" value="https://cf.1575-cdn.me">

    <label>Username</label>
    <input id="username" placeholder="username">

    <label>Password</label>
    <input id="password" type="password" placeholder="password">

    <button id="checkBtn" type="button">Check Expiry</button>

    <div id="output" class="result">Ready.</div>
    <div class="muted">
      If the server blocks browser requests (CORS), you’ll see the error here.
    </div>
  </div>

<script>
(function () {
  var btn = document.getElementById("checkBtn");
  var out = document.getElementById("output");

  function safeTrim(v){ return (v || "").trim(); }

  function show(msg){ out.textContent = msg; }

  function unixToLocalString(sec){
    var n = parseInt(sec, 10);
    if (!isFinite(n)) return null;
    var d = new Date(n * 1000);
    if (isNaN(d.getTime())) return null;
    return d.toLocaleString();
  }

  async function checkExpiry() {
    btn.disabled = true;
    show("Checking…"); // proves click worked immediately

    try {
      var server = safeTrim(document.getElementById("server").value).replace(/\/+$/, "");
      var user   = safeTrim(document.getElementById("username").value);
      var pass   = safeTrim(document.getElementById("password").value);

      if (!server || !user || !pass) {
        show("Please fill in Server URL, Username and Password.");
        return;
      }

      // Cache bust
      var url = server + "/player_api.php?username=" + encodeURIComponent(user) +
                "&password=" + encodeURIComponent(pass) + "&_=" + Date.now();

      var res = await fetch(url, { method: "GET", cache: "no-store" });
      var text = await res.text();

      if (!res.ok) {
        show("HTTP error: " + res.status + " " + res.statusText + "\n\n" + text.slice(0, 600));
        return;
      }

      var data;
      try { data = JSON.parse(text.trim().replace(/^\uFEFF/, "")); }
      catch (e) {
        show("Response was not valid JSON (often a block page).\n\n" + text.slice(0, 600));
        return;
      }

      var ui = data && data.user_info ? data.user_info : null;
      var exp = ui && ui.exp_date ? ui.exp_date : null;

      if (!exp || exp === "0") {
        show("Could not find user_info.exp_date in the response.\n\n" + text.slice(0, 600));
        return;
      }

      var expiryStr = unixToLocalString(exp);
      if (!expiryStr) {
        show("exp_date found but could not convert: " + exp);
        return;
      }

      var expiryMs = parseInt(exp, 10) * 1000;
      var days = Math.floor((expiryMs - Date.now()) / 86400000);
      var statusHtml = (days >= 0) ? '<span class="ok">ACTIVE</span>' : '<span class="bad">EXPIRED</span>';

      out.innerHTML =
        "<b>Status:</b> " + statusHtml + "<br>" +
        "<b>Expiry date:</b> " + expiryStr + "<br>" +
        "<b>Days remaining:</b> " + days;

    } catch (e) {
      show(
        "Error: " + (e && e.message ? e.message : String(e)) + "\n\n" +
        "Most common cause: the IPTV server blocks browser requests (CORS)."
      );
    } finally {
      btn.disabled = false;
    }
  }

  btn.addEventListener("click", checkExpiry);
})();
</script>
</body>
</html>
